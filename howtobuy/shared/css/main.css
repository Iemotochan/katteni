/**
 * RYOã‚³ã‚¤ãƒ³ ã‚µã‚¦ãƒ³ãƒ‰ãƒãƒ™ãƒ« å…±é€šåŸºç›¤ã‚·ã‚¹ãƒ†ãƒ 
 * éŸ³å£°åˆ¶å¾¡ã¨ãƒšãƒ¼ã‚¸å¾©å¸°æ©Ÿèƒ½ã‚’æ”¹å–„
 */
class SoundNovelBase {
    constructor() {
        this.audioEnabled = false;
        this.userHasInteracted = false;
        this.lastTouchTime = 0;
        this.touchCooldown = 400;
        this.typewriterInterval = null;
        this.isTyping = false;
        
        // éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
        this.voicePlayer = null;
        this.kobanSoundPlayer = null;
        
        // éŸ³å£°çŠ¶æ…‹ç®¡ç†
        this.voiceInitialized = false;
        this.voiceIsPlaying = false;
        
        // ãƒšãƒ¼ã‚¸å¾©å¸°æ¤œå‡º
        this.wasPageHidden = false;
        this.returnDetectionActive = false;
        this.pcReturnHandlers = [];
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
        this.characters = {
            ryoko: {
                name: 'ä¸¡å­å…ˆç”Ÿ',
                image: '../shared/images/ryokosensei.png',
                voice: 'female'
            },
            zenta: {
                name: 'ã‚¼ãƒ³å¤ªå…ˆç”Ÿ',
                image: '../shared/images/zentasensei.png',
                voice: 'male'
            }
        };
        
        this.init();
    }
    
    init() {
        console.log('ğŸ­ ã‚µã‚¦ãƒ³ãƒ‰ãƒãƒ™ãƒ«åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
        
        if (!this.checkRequiredElements()) {
            console.error('âŒ å¿…è¦ãªHTMLè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }
        
        this.setupAudioElements();
        this.setupEventListeners();
        this.setupPageReturnHandling();
        this.showAudioDialog();
        
        console.log('âœ… ã‚µã‚¦ãƒ³ãƒ‰ãƒãƒ™ãƒ«åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
    }
    
    // å¿…è¦ãªè¦ç´ ãƒã‚§ãƒƒã‚¯
    checkRequiredElements() {
        const requiredIds = [
            'bubbleText', 'characterImg', 'tapIndicator', 
            'progressBar', 'progressCurrent', 'progressTotal', 
            'audioDialog', 'screenshotImg'
        ];
        
        for (let id of requiredIds) {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`âŒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${id}`);
                return false;
            }
        }
        return true;
    }
    
    // éŸ³å£°è¦ç´ ã®è¨­å®šï¼ˆoshiete.mp3ã®ã¿ï¼‰
    setupAudioElements() {
        this.voicePlayer = document.getElementById('voicePlayer');
        
        // å°åˆ¤åŠ¹æœéŸ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‹•çš„ã«ä½œæˆ
        this.kobanSoundPlayer = new Audio();
        this.kobanSoundPlayer.src = '../shared/audio/koban.mp3';
        this.kobanSoundPlayer.volume = 0.3;
        this.kobanSoundPlayer.preload = 'auto';
        
        // éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¨­å®š
        if (this.voicePlayer) {
            this.voicePlayer.innerHTML = `
                <source src="../shared/audio/oshiete.mp3" type="audio/mpeg">
            `;
            this.voicePlayer.loop = true;
            this.voicePlayer.volume = 0.6;
            this.voicePlayer.preload = 'auto';
            
            this.voicePlayer.addEventListener('canplaythrough', () => {
                console.log('âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†');
                this.voiceInitialized = true;
            });
            
            this.voicePlayer.addEventListener('play', () => {
                this.voiceIsPlaying = true;
                console.log('ğŸµ éŸ³å£°å†ç”Ÿé–‹å§‹ï¼');
            });
            
            this.voicePlayer.addEventListener('pause', () => {
                this.voiceIsPlaying = false;
                console.log('â¸ï¸ éŸ³å£°åœæ­¢');
            });
            
            this.voicePlayer.addEventListener('error', (e) => {
                console.error('âŒ éŸ³å£°ã‚¨ãƒ©ãƒ¼:', e);
            });
        }
        
        console.log('âœ… éŸ³å£°è¦ç´ è¨­å®šå®Œäº†ï¼ˆoshiete.mp3 + koban.mp3ã®ã¿ï¼‰');
    }
    
    // ãƒšãƒ¼ã‚¸å¾©å¸°æ¤œå‡ºã®è¨­å®š
    setupPageReturnHandling() {
        console.log('ğŸ”„ ãƒšãƒ¼ã‚¸å¾©å¸°æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ é–‹å§‹');
        
        // åŸºæœ¬çš„ãªãƒšãƒ¼ã‚¸å¯è¦–æ€§å¤‰æ›´
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.wasPageHidden = true;
                this.returnDetectionActive = true;
                console.log('ğŸ“± ãƒšãƒ¼ã‚¸éè¡¨ç¤º â†’ å¾©å¸°æ¤œå‡ºãƒ¢ãƒ¼ãƒ‰é–‹å§‹');
                // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹æ™‚ã«éŸ³å£°ã‚’åœæ­¢
                this.pauseAllAudio();
            } else {
                if (this.wasPageHidden) {
                    console.log('ğŸ‰ ãƒšãƒ¼ã‚¸å¾©å¸°æ¤œå‡ºï¼');
                    this.handlePageReturn('visibilitychange');
                }
            }
        });
        
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°
        const focusHandler = () => {
            if (this.returnDetectionActive) {
                console.log('ğŸ‰ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¾©å¸°æ¤œå‡ºï¼');
                this.handlePageReturn('focus');
            }
        };
        window.addEventListener('focus', focusHandler);
        this.pcReturnHandlers.push(() => window.removeEventListener('focus', focusHandler));
        
        // ãƒšãƒ¼ã‚¸è¡¨ç¤ºã‚¤ãƒ™ãƒ³ãƒˆ
        const pageshowHandler = (e) => {
            if (e.persisted || this.returnDetectionActive) {
                console.log('ğŸ‰ ãƒšãƒ¼ã‚¸è¡¨ç¤ºå¾©å¸°æ¤œå‡ºï¼');
                this.handlePageReturn('pageshow');
            }
        };
        window.addEventListener('pageshow', pageshowHandler);
        this.pcReturnHandlers.push(() => window.removeEventListener('pageshow', pageshowHandler));
        
        console.log('âœ… ãƒšãƒ¼ã‚¸å¾©å¸°æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ è¨­å®šå®Œäº†');
    }
    
    // ãƒšãƒ¼ã‚¸å¾©å¸°å‡¦ç†
    handlePageReturn(triggerEvent) {
        console.log(`ğŸ’– ãŠã‹ãˆã‚Šãªã•ã„ï¼ï¼ˆ${triggerEvent}ã§æ¤œå‡ºï¼‰`);
        this.wasPageHidden = false;
        this.returnDetectionActive = false;
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«è¨­å®š
        this.userHasInteracted = true;
        
        // éŸ³å£°ã®å¾©å¸°å‡¦ç†ï¼ˆæœ‰åŠ¹ãªå ´åˆã®ã¿ï¼‰
        if (this.audioEnabled && this.voicePlayer && this.voiceInitialized) {
            setTimeout(() => {
                console.log('ğŸ¤ éŸ³å£°å¾©å¸°å‡¦ç†é–‹å§‹...');
                this.playVoice();
            }, 500);
        }
        
        // å°åˆ¤åŠ¹æœéŸ³ã§ãŠå‡ºè¿ãˆ
        setTimeout(() => {
            this.playKobanSound();
        }, 300);
    }
    
    // éŸ³å£°å†ç”Ÿ
    playVoice() {
        if (!this.audioEnabled || !this.voicePlayer || !this.userHasInteracted) {
            return;
        }
        
        console.log('ğŸµ éŸ³å£°å†ç”Ÿè©¦è¡Œ...');
        this.voicePlayer.currentTime = 0;
        const playPromise = this.voicePlayer.play();
        
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log('âœ… éŸ³å£°å†ç”ŸæˆåŠŸï¼');
                this.voiceIsPlaying = true;
            }).catch(error => {
                console.error('âŒ éŸ³å£°å†ç”Ÿå¤±æ•—:', error);
            });
        }
    }
    
    // å°åˆ¤åŠ¹æœéŸ³å†ç”Ÿ
    playKobanSound() {
        if (!this.kobanSoundPlayer) return;
        
        try {
            this.kobanSoundPlayer.currentTime = 0;
            this.kobanSoundPlayer.play().then(() => {
                console.log('ğŸª™ å°åˆ¤åŠ¹æœéŸ³å†ç”Ÿï¼');
            }).catch(e => {
                console.warn('ğŸ”‡ å°åˆ¤åŠ¹æœéŸ³å†ç”Ÿå¤±æ•—:', e);
            });
        } catch (error) {
            console.warn('ğŸ”‡ å°åˆ¤åŠ¹æœéŸ³ã‚¨ãƒ©ãƒ¼:', error);
        }
    }
    
    // å…¨éŸ³å£°åœæ­¢
    pauseAllAudio() {
        if (this.voicePlayer) {
            this.voicePlayer.pause();
        }
        if (this.kobanSoundPlayer) {
            this.kobanSoundPlayer.pause();
        }
        console.log('â¸ï¸ å…¨éŸ³å£°åœæ­¢');
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    setupEventListeners() {
        // å…¨ç”»é¢ã‚¿ãƒƒãƒå¯¾å¿œ
        document.addEventListener('touchend', (e) => this.handleGlobalTouch(e));
        document.addEventListener('click', (e) => this.handleGlobalTouch(e));
        
        // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        const skipBtn = document.getElementById('skipBtn');
        const backBtn = document.getElementById('backBtn');
        const audioOnBtn = document.getElementById('audioOnBtn');
        const audioOffBtn = document.getElementById('audioOffBtn');
        
        if (skipBtn) {
            skipBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.nextScene();
            });
        }
        
        if (backBtn) {
            backBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.previousScene();
            });
        }
        
        if (audioOnBtn) {
            audioOnBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.enableAudio();
            });
        }
        
        if (audioOffBtn) {
            audioOffBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.disableAudio();
            });
        }
        
        console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¿ãƒƒãƒå‡¦ç†
    handleGlobalTouch(e) {
        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºä¸­ã¯ç„¡è¦–
        const audioDialog = document.getElementById('audioDialog');
        if (audioDialog && audioDialog.classList.contains('show')) {
            return;
        }
        
        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
        if (e.target.closest('.nav-btn, .dialog-btn')) {
            return;
        }
        
        // ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º
        const linkElement = e.target.closest('a');
        if (linkElement) {
            e.preventDefault();
            e.stopPropagation();
            const url = linkElement.href;
            const linkType = linkElement.getAttribute('data-link-type');
            
            if (url && url.startsWith('http')) {
                console.log('ğŸ”— ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º:', url);
                
                if (linkType === 'bittrade') {
                    // BitTradeãƒªãƒ³ã‚¯ã¯åŒä¸€ã‚¿ãƒ–ã§é–‹ã
                    this.returnDetectionActive = true;
                    window.location.href = url;
                } else {
                    // ãã®ä»–ã®ãƒªãƒ³ã‚¯ã¯æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                    window.open(url, '_blank', 'noopener,noreferrer');
                }
                
                this.playKobanSound();
            }
            return;
        }
        
        // é€šå¸¸ã®ã‚¿ãƒƒãƒå‡¦ç†
        this.handleTouch(e);
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå‡¦ç†
    handleTouch(e) {
        // åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’è¨˜éŒ²
        if (!this.userHasInteracted) {
            this.userHasInteracted = true;
            console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ¤œå‡º â†’ éŸ³å£°å†ç”Ÿå¯èƒ½çŠ¶æ…‹');
            
            // éŸ³å£°é–‹å§‹ï¼ˆæœ‰åŠ¹ãªå ´åˆï¼‰
            if (this.audioEnabled) {
                setTimeout(() => this.playVoice(), 500);
            }
        }
        
        const now = Date.now();
        if (now - this.lastTouchTime < this.touchCooldown) {
            return;
        }
        this.lastTouchTime = now;
        
        // åŠ¹æœéŸ³å†ç”Ÿ
        this.playKobanSound();
        
        // éŸ³å£°ãŒåœæ­¢ã—ã¦ã„ãŸã‚‰å†é–‹ã‚’è©¦è¡Œ
        if (this.audioEnabled && !this.voiceIsPlaying && this.userHasInteracted) {
            this.playVoice();
        }
        
        if (this.isTyping) {
            this.completeTyping();
            return;
        }
        
        this.nextText();
    }
    
    // éŸ³å£°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
    showAudioDialog() {
        const dialog = document.getElementById('audioDialog');
        if (dialog) {
            dialog.classList.add('show');
        }
    }
    
    // éŸ³å£°æœ‰åŠ¹åŒ–
    enableAudio() {
        this.audioEnabled = true;
        this.userHasInteracted = true;
        this.hideAudioDialog();
        this.startStory();
        
        setTimeout(() => {
            this.playVoice();
        }, 1000);
        
        console.log('ğŸ”Š éŸ³å£°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹åŒ–');
    }
    
    // éŸ³å£°ç„¡åŠ¹åŒ–
    disableAudio() {
        this.audioEnabled = false;
        this.userHasInteracted = true;
        this.hideAudioDialog();
        this.startStory();
        
        console.log('ğŸ”‡ ç„¡éŸ³ãƒ¢ãƒ¼ãƒ‰ï¼ˆåŠ¹æœéŸ³ã®ã¿ï¼‰');
    }
    
    hideAudioDialog() {
        const dialog = document.getElementById('audioDialog');
        if (dialog) {
            dialog.classList.remove('show');
        }
    }
    
    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    destroy() {
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        this.pcReturnHandlers.forEach(cleanup => cleanup());
        this.pcReturnHandlers = [];
        
        if (this.typewriterInterval) {
            clearInterval(this.typewriterInterval);
            this.typewriterInterval = null;
        }
        
        this.pauseAllAudio();
        
        console.log('ğŸ§¹ ã‚µã‚¦ãƒ³ãƒ‰ãƒãƒ™ãƒ«åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ  ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
    }
    
    // æŠ½è±¡ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆå„è©±ã§å®Ÿè£…ï¼‰
    nextText() { console.warn('nextText()ã¯å„è©±ã§å®Ÿè£…ã—ã¦ãã ã•ã„'); }
    nextScene() { console.warn('nextScene()ã¯å„è©±ã§å®Ÿè£…ã—ã¦ãã ã•ã„'); }
    previousScene() { console.warn('previousScene()ã¯å„è©±ã§å®Ÿè£…ã—ã¦ãã ã•ã„'); }
    completeTyping() { console.warn('completeTyping()ã¯å„è©±ã§å®Ÿè£…ã—ã¦ãã ã•ã„'); }
    startStory() { console.warn('startStory()ã¯å„è©±ã§å®Ÿè£…ã—ã¦ãã ã•ã„'); }
}

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
window.addEventListener('beforeunload', () => {
    if (window.soundNovelBase) {
        window.soundNovelBase.destroy();
    }
});

console.log(`
ğŸ­ RYOã‚³ã‚¤ãƒ³ ã‚µã‚¦ãƒ³ãƒ‰ãƒãƒ™ãƒ«åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ 
Version: 3.0 (æ”¹è‰¯ç‰ˆ)

âœ¨ ä¸»ãªæ”¹å–„ç‚¹:
- ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’oshiete.mp3 + koban.mp3ã®ã¿ã«ç°¡ç´ åŒ–
- ğŸ”„ ãƒšãƒ¼ã‚¸å¾©å¸°æ™‚ã®éŸ³å£°åˆ¶å¾¡ã‚’å®Œå…¨æ”¹å–„
- â¸ï¸ ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ç¢ºå®ŸãªéŸ³å£°åœæ­¢
- ğŸ“± ã‚¹ãƒãƒ›ãƒ»PCä¸¡å¯¾å¿œã®å¾©å¸°æ¤œå‡º
- ğŸ§¹ ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- ğŸ¯ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªéŸ³å£°åˆ¶å¾¡

ğŸ® ãƒ‡ãƒãƒƒã‚°ç”¨:
window.soundNovelBase ã§åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
`);
